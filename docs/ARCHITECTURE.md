# Архитектура FFmpeg API сервиса

## Обзор системы

Сервис предоставляет REST API для асинхронной обработки видео файлов с использованием FFmpeg. Поддерживает горизонтальное масштабирование, очереди задач с приоритетами, и хранение файлов в MinIO.

## Компоненты архитектуры

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Nginx Reverse Proxy                          │
│                   (SSL termination, load balancing)                 │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
            │ FastAPI      │ │ FastAPI      │ │ FastAPI      │
            │ Worker 1     │ │ Worker 2     │ │ Worker N     │
            └──────────────┘ └──────────────┘ └──────────────┘
                    │               │               │
                    └───────────────┼───────────────┘
                                    ▼
                    ┌───────────────────────────────┐
                    │     Redis (очередь задач)    │
                    │     - Celery                  │
                    │     - Кэш состояния           │
                    └───────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
            │ FFmpeg       │ │ FFmpeg       │ │ FFmpeg       │
            │ Processor 1  │ │ Processor 2  │ │ Processor N  │
            └──────────────┘ └──────────────┘ └──────────────┘
                    │               │               │
                    └───────────────┼───────────────┘
                                    ▼
                    ┌───────────────────────────────┐
                    │     MinIO Storage            │
                    │     - Входные файлы          │
                    │     - Выходные файлы         │
                    └───────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
            │ PostgreSQL   │ │ Prometheus   │ │ Grafana     │
            │             │ │ + Metrics   │ │ Dashboard   │
            └──────────────┘ └──────────────┘ └──────────────┘
```

## Технологический стек

| Компонент | Технология | Версия | Назначение |
|-----------|------------|--------|------------|
| API Gateway | Nginx | latest | Load balancing, SSL, rate limiting |
| Web Framework | FastAPI | 0.100+ | REST API, async I/O |
| Auth | JWT + OAuth2 | - | Аутентификация и авторизация |
| Task Queue | Redis + Celery | 5.0+ | Очередь задач с приоритетами |
| Video Processing | FFmpeg + ffmpeg-python | 4.4+ | Обработка видео |
| Database | PostgreSQL | 15+ | Хранение задач, логов, настроек |
| Object Storage | MinIO | latest | Хранение видео файлов |
| Cache | Redis | 7.0+ | Кэширование состояния задач |
| Monitoring | Prometheus + Grafana | latest | Метрики и мониторинг |
| Logging | Loki | latest | Логи |
| Containerization | Docker + Docker Compose | latest | Контейнеризация |
| ASGI Server | Uvicorn | 0.23+ | ASGI сервер для FastAPI |
| ORM | SQLAlchemy | 2.0+ | Работа с PostgreSQL |
| Pydantic | 2.0+ | Валидация данных |

## Требования к системе

### Производительность
- До 100 одновременных запросов
- Обработка видео до 1 ГБ
- Горизонтальное масштабирование
- Минимальное время обработки

### Форматы файлов
- Входное видео: MP4, AVI (расширяемо)
- Аудио: MP3, AAC, WAV
- Субтитры: SRT, VTT, ASS/SSA
- Выходное видео: настраиваемый формат и кодек

### Функциональные возможности
1. Объединение нескольких видео файлов
2. Наложение аудио (замена или микс с синхронизацией)
3. Наложение текста (полная кастомизация)
4. Наложение субтитров (генерация и импорт)
5. Picture-in-Picture (наложение видео на видео)
6. Комбинированные операции

## Обработка задач

### Жизненный цикл задачи

1. **Создание** - Клиент отправляет запрос с конфигурацией
2. **Валидация** - Проверка входных данных и файлов
3. **Постановка в очередь** - Задача добавляется в Redis с приоритетом
4. **Обработка** - Worker забирает задачу и выполняет FFmpeg операции
5. **Прогресс** - Обновление статуса задачи (0-100%)
6. **Завершение** - Успешное завершение или ошибка
7. **Хранение** - Результат загружается в MinIO
8. **Очистка** - Автоудаление через N дней

### Статусы задач
- `pending` - В очереди
- `processing` - В обработке
- `completed` - Успешно завершено
- `failed` - Ошибка (можно повторить)
- `cancelled` - Отменено пользователем

### Приоритеты задач
- 1-3: Высокий (срочные)
- 4-7: Обычный
- 8-10: Низкий

## Масштабирование

### Горизонтальное масштабирование
- Несколько FastAPI workers за Nginx
- Несколько FFmpeg processors
- Redis Cluster для очередей
- PostgreSQL streaming replication

### Vertical scaling
- Увеличение ресурсов контейнеров
- Оптимизация FFmpeg команд
- Кэширование результатов

## Безопасность

- JWT токены для аутентификации
- Rate limiting по IP
- Валидация всех входных данных
- Изолированные Docker контейнеры
- HTTPS/TLS шифрование
- API ключи для интеграций

## Мониторинг и логирование

### Метрики
- Время обработки задач
- Размер входных/выходных файлов
- Процент успешных операций
- Размер очереди задач
- CPU/Memory использование

### Логи
- Все HTTP запросы
- Статусы задач
- Ошибки и исключения
- FFmpeg вывод

## Резервное копирование

- База данных: ежедневные дампы
- MinIO: репликация buckets
- Redis: RDB + AOF persistence
